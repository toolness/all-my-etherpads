<!DOCTYPE html>
<html manifest="cache.manifest">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1, maximum-scale=1">
<title>All My Etherpads</title>
<script src="jquery.min.js"></script>
<script src="jquery.mobile-1.0a4.1.min.js"></script>
<script src="event-emitter.js"></script>
<script>
function makeHash(url) {
  url = url.replace(/[:\/]/g, '_');
  return url.replace(/\./g, "dot");
}

jQuery.extend({
  showErrorMessage: function(msg) {
    // Taken from jQuery Mobile's source code.
		$("<div class='ui-loader ui-overlay-shadow ui-body-e ui-corner-all'>" +
		  "<h1></h1></div>")
			.css({ "display": "block", "opacity": 0.96, "top": $(window).scrollTop() + 100 })
			.appendTo( $.mobile.pageContainer )
			.delay( 800 )
			.fadeOut( 400, function(){
				$(this).remove();
			}).find("h1").text(msg);
  }
});

function EtherpadPage(options) {
  var url = options.url;
  var server = options.server;
  var id = makeHash(url);
  var page = $('#templates div.detail').clone();
  var listItem = null;
  
  page.attr('id', id);
  $('div#detail-pages').append(page);

  // This is a weird thing we need to do in order for the new page
  // to exist and be linkable.
  page.attr('data-url', id).page();    
  
  page.find('h1').text(url);
  page.find('.open').attr('href', url);
  
  function update(etherpad) {
    if (!listItem) {
      listItem = $('#templates .list-item').clone();
      listItem.attr("id", "item-" + id);
      listItem.find("a").attr('href', "#" + id);
      listItem.find("div.title").text(url);
      $("#etherpads").append(listItem);
      $("#etherpads").data('listview').refresh();
    }
    listItem.find(".last-sync").text(etherpad.lastSync.toString());
    page.find('.pad-content').html(etherpad.html);
  }
  
  var self = {
    load: function load() {
      jQuery.mobile.pageLoading();
      
      var response = server.load(url);
      response.on('error', function(reason) {
        jQuery.mobile.pageLoading(true);
        jQuery.showErrorMessage("Error: " + reason);
      });
      response.on('load', function(etherpad) {
        jQuery.mobile.pageLoading(true);
        update(etherpad);
      });
    },
    remove: function remove() {
      jQuery.mobile.pageLoading();

      var response = server.remove(url);

      response.on('done', function() {
        jQuery.mobile.pageLoading(true);
        $("li#item-" + id).remove();
        $("#etherpads").data('listview').refresh();
        // TODO: What if the user is already at the home page?
        jQuery.mobile.changePage("home");
      });
    }
  };

  page.find('.resync').click(self.load);
  page.find('.remove').click(self.remove);

  return self;
}

var fakeServer = {
  DELAY: 1000,
  load: function(url) {
    var response = jQuery.eventEmitter({});
    setTimeout(function() {
      if (url == "http://etherpad.mozilla.org:9000/hai2u") {
        jQuery.get("example-response.html", function(html) {
          response.emit('load', {
            lastSync: new Date(),
            html: html
          });
        }, "text");
      } else
        response.emit('error', "Etherpad not found.");
    }, this.DELAY);
    return response;
  },
  remove: function(url) {
    var response = jQuery.eventEmitter({});
    
    setTimeout(function() {
      response.emit('done');
    }, this.DELAY);
    
    return response;
  }
};

// Taken from http://stackoverflow.com/questions/736513/how-do-i-parse-a-url-into-hostname-and-path-in-javascript
var getLocation = function(href) {
  var l = document.createElement("a");
  l.href = href;
  return l
}

function BasicCache(options) {
  var cache = options.cache || window.localStorage;
  var prefix = options.prefix || "BASIC_CACHE_";
  
  var self = {
    list: function list() {
      var results = [];
      for (var name in cache) {
        if (name.indexOf(prefix) == 0)
          results.push(name.slice(prefix.length));
      }
      return results;
    },
    has: function has(url) {
      return ((prefix+url) in cache);
    },
    get: function get(url, cb) {
      cb(JSON.parse(cache[prefix+url]));
    },
    set: function set(url, blob) {
      cache[prefix+url] = JSON.stringify(blob);
    },
    remove: function remove(url, cb) {
      delete cache[prefix+url];
      cb();
    },
    removeAll: function removeAll() {
      self.list().forEach(function(url) {
        self.remove(url, function() {});
      });
    }
  };
  
  return self;
}

function RealServer(options) {
  var cache = options.cache;
  var network = options.network || jQuery;
  var gateway = options.gateway || "http://etherpad-export.appspot.com/";

  var self = {
    list: function() {
      return cache.list();
    },
    load: function(url) {
      var response = jQuery.eventEmitter({});

      function loadCachedResponse() {
        cache.get(url, function(etherpad) {
          setTimeout(function() {
            etherpad.lastSync = new Date(etherpad.lastSync);
            response.emit('load', etherpad);
          }, 0);
        });
      }
      
      if (cache.has(url)) {
        loadCachedResponse();
        return response;
      }

      var loc = getLocation(url);
      var params = {
        server: loc.hostname,
        port: loc.port,
        pad: loc.pathname.slice(1),
        format: "html"
      };

      if (params.port == "0")
        params.port = "80";

      network.ajax({
        type: 'GET',
        crossDomain: true,
        url: gateway,
        data: params,
        dataType: "text",
        error: function(jqXHR, textStatus, errorThrown) {
          var msg = "Fetching the pad failed.";
          
          if (jqXHR.status == 404) {
            msg = "No pad exists at that url.";
          }
          
          response.emit('error', msg);
        },
        success: function(data) {
          cache.set(url, {
            lastSync: (new Date()).toString(),
            html: data
          });
          loadCachedResponse();
        },
        timeout: 10000        
      });

      return response;
    },
    remove: function(url) {
      var response = jQuery.eventEmitter({});

      cache.remove(url, function() {
        setTimeout(function() {
          response.emit('done');
        }, 0);
      });

      return response;
    }
  };
  
  return self;
}

var cache = BasicCache({prefix: "ETHERPADS_"});
var server = RealServer({cache: cache});

$(window).ready(function() {
  function clearForm() {
    $("#url").val('');
  }

  $("form#add-pad").submit(function() {
    var url = $("#url").val();
    if (url.length) {
      var page = EtherpadPage({
        url: url,
        server: server
      });
      page.load();
      clearForm();
    } else {
      jQuery.showErrorMessage("Please enter a URL.");
    }
    return false;
  });

  $("input#export-list").click(function() {
    jQuery.showErrorMessage("TODO: Implement this.");
  });

  server.list().forEach(function(url) {
    var page = EtherpadPage({
      url: url,
      server: server
    });
    page.load();    
  });

  // Not sure how to display a dynamically-generated
  // page on page load, so we'll reset the hash to the
  // home page until we figure out how to do that.
  window.location.hash = "#home";
});
</script>
<style>
@import url('jquery.mobile-1.0a4.1.min.css');
</style>
<div data-role="page" id="home">
  <div data-role="header">
    <h1>All My Etherpads</h1>
  </div>
  <div data-role="content">
    <ul id="etherpads" data-role="listview" data-filter="true" data-theme="c">
    </ul>
    <form id="add-pad">
      <h2>Add a Pad</h2>
      <p>You can use this form to add an Etherpad to your list, allowing you to easily access it offline on this device.</p>
      <div data-role="fieldcontain">
          <label for="url">Etherpad URL:</label>
          <input type="text" name="url" id="url" value=""  />
          <input type="submit" value="Add" /> 
      </div>
    </form>
    <h2>Export</h2>
    <p>Click the button below to generate a URL that can be used to install your list on another device.</p>
    <input type="button" value="Export List" id="export-list">
  </div>
</div>
<div id="detail-pages"></div>
<div id="templates" style="display: none">
  <li class="list-item"><a><div class="title"></div><p class="ui-li-aside">Last synced on <span class="last-sync"></span></p></a></li>
  <div data-role="page" class="detail">
    <div data-role="header">
      <h1>hallo</h1>
      <a href="#home" data-icon="home" data-iconpos="notext" data-direction="reverse" class="ui-btn-right jqm-home">Home</a>
    </div>
    <div data-role="content">
      <div data-role="controlgroup">
        <a class="open" href="http://google.com/" target="_blank" data-role="button">Open In Etherpad</a>
        <input type="button" value="Re-Sync" class="resync"></input>
        <input type="button" value="Remove" class="remove"></input>
      </div>
      <div class="pad-content"></div>
    </div>
  </div>
</div>
</html>
