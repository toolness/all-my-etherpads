<!DOCTYPE html>
<html manifest="cache.manifest">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1, maximum-scale=1">
<title>All My Etherpads</title>
<script src="jquery.min.js"></script>
<script src="jquery.mobile-1.0a4.1.min.js"></script>
<script src="event-emitter.js"></script>
<script>
function makeHash(url) {
  url = url.replace(/[:\/]/g, '_');
  return url.replace(/\./g, "dot");
}

function EtherpadPage(options) {
  var url = options.url;
  var server = options.server;
  var id = makeHash(url);
    var page = $('#templates div.detail').clone();
  
  page.attr('id', id);
  $('div#detail-pages').append(page);

  // This is a weird thing we need to do in order for the new page
  // to exist and be linkable.
  page.attr('data-url', id).page();    
  
  page.find('h1').text(url);
  page.find('.open').attr('href', url);
  
  var self = {
    load: function load() {
      jQuery.mobile.pageLoading();
      
      var response = server.load(url);
      response.on('error', function(reason) {
        jQuery.mobile.pageLoading(true);
        alert("TODO: ERROR " + reason);
      });
      response.on('load', function(etherpad) {
        jQuery.mobile.pageLoading(true);
        var newItem = $('<li></li>');
        var link = $('<a></a>');
        var aside = $('<p class="ui-li-aside"></p>');
        newItem.attr("id", "item-" + id);
        aside.text("Last synced on " + etherpad.lastSync);
        link.attr('href', "#" + id);
        link.text(url);
        link.append(aside);
        newItem.append(link);
        $("#etherpads").append(newItem);
        page.find('.pad-content').html(etherpad.html);
        $("#etherpads").data('listview').refresh();
      });
    },
    resync: function resync() {
      alert("TODO: resync");
    },
    remove: function remove() {
      $("li#item-" + id).remove();
      $("#etherpads").data('listview').refresh();
      // TODO: What if the user is already at the home page?
      jQuery.mobile.changePage("home");
    }
  };

  page.find('.resync').click(self.resync);
  page.find('.remove').click(self.remove);

  return self;
}

$(window).ready(function() {
  var fakeServer = {
    load: function(url) {
      var response = jQuery.eventEmitter({});
      setTimeout(function() {
        jQuery.get("example-response.html", function(html) {
          response.emit('load', {
            lastSync: new Date(),
            html: html
          });
        }, "text");
      }, 1000);
      return response;
    }
  };

  function clearForm() {
    $("#url").val('');
  }

  $("form#add-pad").submit(function() {
    var url = $("#url").val();
    if (url.length) {
      var page = EtherpadPage({
        url: url,
        server: fakeServer
      });
      page.load();
      clearForm();
    }
    return false;
  });

  // Not sure how to display a dynamically-generated
  // page on page load, so we'll reset the hash to the
  // home page until we figure out how to do that.
  window.location.hash = "#home";
});
</script>
<style>
@import url('jquery.mobile-1.0a4.1.min.css');
</style>
<div data-role="page" id="home">
  <div data-role="header">
    <h1>All My Etherpads</h1>
  </div>
  <div data-role="content">
    <ul id="etherpads" data-role="listview" data-theme="c">
    </ul>
    <form id="add-pad">
      <h2>Add a Pad</h2>
      <div data-role="fieldcontain">
          <label for="url">Etherpad URL:</label>
          <input type="text" name="url" id="url" value=""  />
          <input type="submit" value="Add" /> 
      </div>
    </form>
  </div>
</div>
<div id="detail-pages"></div>
<div id="templates" style="display: none">
  <div data-role="page" class="detail">
    <div data-role="header">
      <h1>hallo</h1>
      <a href="#home" data-icon="home" data-iconpos="notext" data-direction="reverse" class="ui-btn-right jqm-home">Home</a>
    </div>
    <div data-role="content">
      <div data-role="controlgroup">
        <a class="open" href="http://google.com/" target="_blank" data-role="button">Open In Etherpad</a>
        <input type="button" value="Re-Sync" class="resync"></input>
        <input type="button" value="Remove" class="remove"></input>
      </div>
      <div class="pad-content"></div>
    </div>
  </div>
</div>
</html>
